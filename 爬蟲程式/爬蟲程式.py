from multiprocessing import Pool
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from openpyxl import Workbook
from datetime import datetime
import time
import math

labels = [
  # '佳湘食品有限公司','內埔店','廣東店','東港店','潮州店','大武店','九如店(屏東)','里港店',
  # '小港店','前鎮店','鳳山店','前鎮區公正路(下午)','覺民店','九如店(高雄)','三民店','華寧店','後勁店','楠梓店','楠梓區藍田路','岡山店','旗山夜市',
  # '金華門市','南區金華路','崇德店','東區東安路','北區北園街','永康區','育德店','永康區永大路','龍聖街夜市','鹽行夜市','新市區仁愛街','善化忠孝店','麻豆店','西港門市','佳里店','學甲店','新營區中正路',
  # '嘉義東區和平路','民雄鄉',
  # '麟洛交流道待命點','九如交流道待命點','中正交流道待命點','岡山交流道',
  
  #68
  '佳湘食品有限公司',
  #屏東8
  '內埔','廣東','東港','潮州','大武','九如(屏東)','里港','山地門夜市',
  #高雄20
  '小港','前鎮','鳳山店','公正路','覺民','九如(高雄)','三民','華寧','後勁','楠梓','藍田','岡山','旗甲路',
  '寶珠溝','鳳松','瑞北','彌陀',#彌陀
  '大寮',#
  '路竹',#路竹
  '二苓',#二苓
  #台南27
  '金華','金華路二段','崇德','東安','北園街','中華','育德',
  '永大夜市','聖龍街夜市','鹽行夜市','新市','善化','麻豆','西港','佳里','學甲','新營','富農','建平','鹽水',
  '五王',#五王市場
  '開元',#開元市場
  '灣里',#灣里市場
  '大同',#大同市場
  '仁德',#仁德市場
  '公園',#公園天使貝可
  '健康',#天使貝可
  #嘉義4
  '和平','頭橋','民雄','朴子',
  #雲林1
  '北港',
  #待命7
  '水上交流道附近',
  '麻豆交流道附近',
  '國八交流道附近',
  '岡山交流道附近',
  '九如交流道附近',
  '中正交流道附近',
  '麟洛交流道附近',
]  
locations = [
    #68
    "23.12319164994851,120.19630736278181",
    "22.611282385744527,120.56863049722809","22.686524772025727,120.49455915600369",
    "22.471153063412963,120.45905663079841","22.548107270391352,120.53994780536111",
    "22.657299900296074,120.4760141445099","22.733487047863324,120.49014859265361",
    "22.777029906870276,120.49402790521208","22.704980651813408,120.6417353206781",#山地門
    
    "22.564586478478205,120.35477748160984","22.603844865629153,120.33527800234407",
    "22.629076168716395,120.35094143073837","22.606679134241574,120.3307983282573",
    "22.639430368188926,120.33963513121574","22.64079314316319,120.31115465977418",
    "22.636085185205843,120.2930354639077","22.666444584506515,120.29309321959045",
    "22.719888474472896,120.31134193772873","22.726307344419357,120.32486109593913",
    "22.727579825631786,120.28180293862295","22.799215249261938,120.28976392597055",
    "22.900298173123463,120.48349729639436",
    "22.645626263008527,120.32397458076537",#寶珠溝
    "22.62908314159194,120.35094125575644",#鳳松
    "22.606683098498188,120.33086379686068",#瑞北
    "22.785953308440703,120.24717883560834",#彌陀
    "22.614309911740843,120.40355906626714",#大寮
    "22.87013915017357,120.26645514423683",#路竹區信義巷
    "22.56458607853871,120.35477755283415",#二苓
    "22.977935991583795,120.19107455637344","22.97714084572404,120.188862292867",
    "22.97105063680819,120.22737870929971","22.99462731823846,120.2269576969061",#東安
    "23.010391147514778,120.22309806884903","23.01698359708886,120.22815467536843",
    "23.016850368207542,120.20714080460448","23.018968506425686,120.26277776032812",
    "23.030442624498004,120.25837771750439","23.04178566876676,120.23659944907268",
    "23.075939558987766,120.2933537156832","23.131410027643717,120.30335082057243",
    "23.185056246030573,120.24920232360503","23.12061319885283,120.19883704328528",#西港
    "23.159658560063168,120.1709474873376","23.23285787648706,120.17993740299916",
    "23.31733030937387,120.31624969932795","22.983226964945167,120.23526148691377",#富農
    "22.99018307919648,120.16892365576476",#建平
    "23.319645347416145,120.26745889687675",#鹽水
    "23.01153382094705,120.23709211422124",#五王國小
    "23.010393236291865,120.22310583535933",#開元寺
    "22.92666283542666,120.18214552611147",#灣里路
    "22.977845574719424,120.21376091197097",#大同
    "22.970123871072072,120.25581410599399",#仁德
    "22.99654099869994,120.2059774175683",#公園
    "22.981396730845074,120.19540705174431",#健康 天使貝可
    "23.4785974947183,120.45711284226547","23.524759778198938,120.44035364277093",
    "23.55606521218017,120.42987144529894",#民雄
    "23.46372920310323,120.24377540262451",#朴子
    "23.575226264205305,120.3014636968827",#北港
    "23.44136571360704,120.37940617623926",#水上交流道
    "23.179367433520138,120.23022645951019",#麻豆交流道
    "23.06561210661192,120.27786048933078",#國八交流道
    "22.78709933553913,120.3170170383277",#岡山交流道
    "22.637699946560197,120.337738805268",#九如交流道
    "22.627904588786787,120.3331820703729",#中正交流道
    "22.643193905244434,120.53351690092425",#麟洛交流道


  # "23.123194900408944,120.19630773535724", "22.61128170336671,120.56863055874763",
  # "22.686507565965464,120.49454116852716", "22.47115559819304,120.45906156440952",
  # "22.54810712723752,120.53994832773944", "22.657297317400023,120.47601515930867",
  # "22.73348416627905,120.49015308156615", "22.77703897774027,120.49402619127473",
  # "22.564585860605742,120.35477747803972", "22.60384561641285,120.33527781904999",
  # "22.629078605506464,120.35094057815205", "22.60667832977552,120.33079853012109",
  # "22.639431054621532,120.33963573802437", "22.640795066402585,120.3111553729532",
  # "22.63608718808756,120.29303437046866", "22.666448217836486,120.29309337795493",
  # "22.719887029301862,120.31134312757885", "22.726308354587353,120.32486280173813",
  # "22.72758096305208,120.28180208066581", "22.79921805247248,120.28976467320426",
  # "22.900299938552653,120.48349674840993", "22.977935992240912,120.19107522596204",
  # "22.977144549931925,120.1888609515584", "22.97105187041181,120.22737951609857",
  # "22.994628748076433,120.2269577377337", "23.01039169853432,120.22309669881038",
  # "23.016983840627546,120.22815333355146", "23.016849915151525,120.20714023819777",
  # "23.018968570317572,120.26277728436862", "23.030441700402953,120.25837778896096",
  # "23.04178612377675,120.236598253558", "23.07593909246493,120.29335461730106",
  # "23.13140920274554,120.30335064506632", "23.185053427758092,120.24920341971358",
  # "23.120612928880043,120.19883540797407", "23.159659176455975,120.17094815657656",
  # "23.232860957490328,120.17993757510571", "23.31733216870925,120.31625008406196",
  # "23.47859843943535,120.4571126428651", "23.524759917500667,120.4403553101452",
  # "22.637702229462416,120.53835448050631", "22.7535721166945,120.49167707221277",
  # "22.627351343821246,120.33482363035417", "22.787319410459922,120.31834825861579"
    ]  

def process_batch(tasks):
    options = webdriver.ChromeOptions()
    options.add_argument("--disable-blink-features=AutomationControlled")
    options.add_argument("--headless")
    driver = webdriver.Chrome(service=Service(), options=options)

    results = []
    try:
        for origin, destination, origin_label, dest_label in tasks:
            try:
                driver.get("https://www.google.com.tw/maps/dir///data=!4m2!4m1!3e0")
                wait = WebDriverWait(driver, 20)

                #輸入起點
                from_input = wait.until(EC.presence_of_element_located((By.XPATH, '//div[@id="directions-searchbox-0"]//input')))
                from_input.clear()
                from_input.send_keys(origin)

                #輸入終點
                to_input = wait.until(EC.presence_of_element_located((By.XPATH, '//div[@id="directions-searchbox-1"]//input')))
                to_input.clear()
                to_input.send_keys(destination)
                to_input.send_keys(Keys.ENTER)

                #等待時間結果出現
                duration_element = wait.until(EC.presence_of_element_located(
                    (By.XPATH, '//div[contains(@class, "Fk3sm") and (contains(text(), "分") or contains(text(), "min"))]')
                ))
                duration = duration_element.text
            except Exception as e:
                duration = "查無結果"

            results.append((origin_label, dest_label, duration))
    finally:
        driver.quit()

    return results

if __name__ == '__main__':
    start_time = time.time()
    tasks = []
    for i, (dest_label, dest_loc) in enumerate(zip(labels, locations)):
        for j, (origin_label, origin_loc) in enumerate(zip(labels, locations)):
            if i != j:
                tasks.append((origin_loc, dest_loc, origin_label, dest_label))
    print(f"準備查詢 {len(tasks)} 筆資料...")

    NUM_PROCESSES = 8
    chunk_size = math.ceil(len(tasks) / NUM_PROCESSES)
    task_chunks = [tasks[i:i + chunk_size] for i in range(0, len(tasks), chunk_size)]

    with Pool(processes=NUM_PROCESSES) as pool:
        results_nested = pool.map(process_batch, task_chunks)

    results = [item for sublist in results_nested for item in sublist]

    # 儲存 Excel
    wb = Workbook()
    ws = wb.active
    ws.cell(row=1, column=1, value="labels")

    for idx, label in enumerate(labels, start=2):
        ws.cell(row=1, column=idx, value=label)
        ws.cell(row=idx, column=1, value=label)

    label_to_index = {label: idx + 2 for idx, label in enumerate(labels)}

    for origin_label, dest_label, duration in results:
        row = label_to_index[dest_label]
        col = label_to_index[origin_label]
        ws.cell(row=row, column=col, value=duration)

    now_str = datetime.now().strftime("%Y%m%d_%H%M")
    wb.save(f"D:/route/all/google_map_all_{now_str}.xlsx")
    end_time = time.time()
    duration_sec = end_time - start_time
    print(f"所有任務/8完成，耗時 {duration_sec:.2f} 秒（約 {duration_sec/60:.2f} 分鐘）")
 